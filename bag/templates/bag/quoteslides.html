{% extends "base.html" %}
{% load static %}

{% block content %}

{% block page_header %}
    <div class="container header-container">
        <div class="row mt-5">
            <div class="col mt-5"></div>
        </div>
    </div>
{% endblock %}

<style>
  .card {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  transition: all 0.5s ease-in-out;
  opacity: 1;
}

.card.active {
  opacity: 1;
  z-index: 1;
}

.card.inactive-left {
  opacity: 0;
  transform: translateX(-100%);
  z-index: -1;
}

.card.inactive-right {
  opacity: 0;
  transform: translateX(100%);
  z-index: -1;
}

ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

li {
  margin-bottom: 10px;
}

/* Add margin-bottom to the container holding the page content */
.container.page-content {
    margin-bottom: 100px;
}

</style>

    <div class="overlay"></div>
    <div class="container page-content">

      <div class="pricing-header mx-auto text-center">
          <h1 class="display-4 fw-normal text-black">Get a quote</h1>
          <p class="fs-5 text-muted">Quickly find out the total cost of your project by filling the form below.</p>
      </div>

      <!-- slide start -->
      <div class="container flex-fill d-flex flex-column min-vh-100">
        <div class="row">
          <div class="col-md-6 mx-auto">
            <form method="POST" action="{% url 'bag:add_to_bag' %}">
              {% csrf_token %}
              <div id="card-group">

                <div class="card active" id="card1">
                  <div class="card-body">
                    <h5 class="card-title">Select a type of service</h5>
                    {% for category in categories %}
                    <h2>{{ category }}</h2>
                      {% for service in services %}
                        {% if service.category == category %}
                              <div>
                                  <input type="checkbox" name="services" value="{{ service.id }}">
                                  <label>{{ service.name }} - {{ service.price }}</label>
                              </div>
                        {% endif %}
                      {% endfor %}
                    {% endfor %}
                    <button type="button" class="btn btn-lg btn-outline-black mb-3 next-btn">Next</button>

                  </div>
                </div>

                <div class="card" id="card2">
                  <div class="card-body">

                    <h5 class="card-title">Select a package</h5>
                    <h2>{{ category }}</h2>
                    {% for product in products %}
                      <div>
                          <input type="checkbox" name="products" value="{{ product.id }}">
                          <label>{{ product.name }} - {{ product.price }}</label>
                      </div>
                    {% endfor %}
                    <button type="button" class="btn btn-lg btn-outline-black mb-3 back-btn">Back</button>
                    <button type="button" class="btn btn-lg btn-outline-black mb-3 next-btn">Next</button>

                  </div>
                </div>

                <div class="card" id="card3">
                  <div class="card-body">
                    <div id="quote">

                      <h2 class="display-6 text-center mt-5">Your quote is:</h2>
                      <div class="text-center">
                          {% if grand_total %}
                          ${{ grand_total|floatformat:2 }}
                          {% else %}
                          $0.00
                          {% endif %}
                        </h2>
                        {% if bag_items %}
                        <ul>
                          {% for item in bag_items %}
                          <li>{{ item.product.name }} - {{ item.quantity }} x {{ item.product.price }}</li>
                          {% endfor %}
                        </ul>
                        {% endif %}
                        <p>Product Count: {{ product_count }}</p>
                      </div>
                    </div>

                    <div class="row justify-content-center">
                      <p class="fs-5 text-muted text-center">How does the pricing work? <a href="{% url 'terms' %}" class="oblique">Click here</a> to find out more</p>
                      
                      <h3 class="display-6 text-center mb-4">Would you like to continue?</h3>
                      <a href="{% url 'bag:view_bag' %}" class="btn btn-lg btn-outline-black mb-3">Yes, continue to checkout</a>
                      <h3 class="display-6 text-center mb-4">Or, save this quote and get in touch:</h3>
                    </div>
                    <div class="form-group">
                      <label for="input6">Please write your name:</label>
                      <input type="text" class="form-control" id="input6" placeholder="">
                    </div>
                    <div class="row mt-5">
                      <button type="button" class="btn btn-lg btn-outline-black mb-3 back-btn">Back</button>
                      <button type="submit">Add to bag</button>
                    </div>


                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
      <!-- slide end -->

        <!-- The following script allows user to navigate between them with "Next" and "Back" buttons. -->
        <script>
        // Get all the cards and hide all except the first one
        const cards = document.querySelectorAll('.card');
        for (let i = 1; i < cards.length; i++) {
        cards[i].classList.add('inactive-right');
        }

        // Add a click event listener to the "Next" button
        const nextButtons = document.querySelectorAll('.next-btn');
        nextButtons.forEach((nextButton) => {
        nextButton.addEventListener('click', (event) => {
            event.preventDefault();

            // Get the current card and the next card
            const currentCard = event.target.closest('.card');
            const nextCard = currentCard.nextElementSibling;

            // Add the appropriate classes to the current and next cards
            currentCard.classList.add('inactive-left');
            currentCard.classList.remove('active');
            nextCard.classList.add('active');
            nextCard.classList.remove('inactive-right');
        });
        });

        // Add a click event listener to the "Back" button
        const backButtons = document.querySelectorAll('.back-btn');
        backButtons.forEach((backButton) => {
        backButton.addEventListener('click', (event) => {
            event.preventDefault();

            // Get the current card and the previous card
            const currentCard = event.target.closest('.card');
            const prevCard = currentCard.previousElementSibling;

            // Add the appropriate classes to the current and previous cards
            currentCard.classList.add('inactive-right');
            currentCard.classList.remove('active');
            prevCard.classList.add('active');
            prevCard.classList.remove('inactive-left');
        });
        });
        </script>

        <!-- For each checkbox, the script checks if it is checked.
          If it is, the value of the checkbox (which corresponds to the id of the service)
          is added to an array called selectedServices.
          It also creates creates a JavaScript object called data, which has two properties:
          item_id (the id of the item that the user is interested in) and 
          services (an array of the ids of the services that the user has selected).
      -->

      <script>
        function submitForm(item_id) {
          event.preventDefault();

          // Get selected services
          var services = [];
          var serviceInputs = document.getElementsByName('service_id');
          for (var i = 0; i < serviceInputs.length; i++) {
            if (serviceInputs[i].checked) {
              services.push({
                id: serviceInputs[i].value,
                name: serviceInputs[i].nextElementSibling.textContent,
                price: 0.0,
                quantity: 1,
                type: 'service',
              });
            }
          }

          // Get selected product
          var products = [];
          var productInputs = document.getElementsByName('product_id');
          for (var i = 0; i < productInputs.length; i++) {
            if (productInputs[i].checked) {
              products.push({
                id: productInputs[i].value,
                name: productInputs[i].nextElementSibling.textContent,
                price: parseFloat(productInputs[i].nextElementSibling.textContent.replace('$', '')),
                quantity: 1,
                type: 'product',
              });
            }
          }

          // Combine services and products into a single list
          var items = services.concat(products);

          // Send request to add items to shopping bag
          fetch('/add_to_bag/' + item_id + '/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
              items: items,
            }),
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Show success message
              alert('Items added to bag successfully!');
              // Reload page to update bag icon and total
              window.location.reload();
            } else {
              // Show error message
              alert('There was an error adding items to bag.');
            }
          });
        }

        // Helper function to get CSRF token from cookie
        function getCookie(name) {
          var cookieValue = null;
          if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
              var cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }

      </script>
</div>

{% endblock %}